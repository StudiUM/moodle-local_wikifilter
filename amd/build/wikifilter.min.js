define ("mod_wikifilter/wikifilter",["jquery","core/ajax","core/form-autocomplete","core/str","core/notification"],function(a,b,c,d,e){function f(){this.table=a("#id_associations_table");this.tableClone=a("#table_clone");this.rowClone=a(".row_clone",this.tableClone);this.emptyRowClone=a(".empty_row_clone",this.tableClone);this.addRow=function(b,c){var d=this.rowClone.clone();d.removeClass("row_clone");var e=this.buildRowData(b,c);this.fillRow(d,e);if(a("tr.empty_row").length){a("tr.empty_row").remove()}a("tbody",this.table).append(d)};this.modifyRow=function(a,b,c){var d=this.buildRowData(b,c);this.fillRow(a,d)};this.deleteRow=function(b){b.remove();if(!a("tbody .actions",this.table).length){var c=this.emptyRowClone.clone();c.removeClass("empty_row_clone").addClass("empty_row");a("tbody",this.table).append(c)}};this.empty=function(){if(!a(".empty_row",this.table).length){a("tbody .actions",this.table).closest("tr").remove();var b=this.emptyRowClone.clone();b.removeClass("empty_row_clone").addClass("empty_row");a("tbody",this.table).append(b)}};this.buildRowData=function(b,c){var d=b.name,e="",f="";c.each(function(){var c=a(this),d=c.attr("data-value"),g=c.text().replace("\xD7","");e+="<span class=\"badge badge-info mb-3 mr-1\" data-id=\""+d+"\">"+g+"</span>";f+="<input name=\"associations[]\" type=\"hidden\" value=\""+b.id+"-"+d+"\">"});var g={roleId:b.id,roleName:b.name,roleCell:d,tagsCell:e,actionsCell:f};return g};this.fillRow=function(b,c){a(".role",b).html(c.roleCell);a(".tags",b).html(c.tagsCell);a(".actions .db-data",b).html(c.actionsCell);a(".actions",b).attr("data-roleid",c.roleId);a(".actions",b).attr("data-rolename",c.roleName)}}function g(){this.id="#id_role";this.element=a(this.id);this.showInEditMode=function(a){this.addOption(a.id,a.name);this.setValue(a.id);this.disable()};this.showInAddMode=function(b){var c=this;this.enable();a(".actions",b).each(function(){var b=a(this).attr("data-roleid");c.deleteOption(b)})};this.setValue=function(a){this.element.val(a)};this.getSelectedOption=function(){return{id:this.element.val(),name:this.element.find("option:selected").text()}};this.deleteSelectedOption=function(){this.element.find("option:selected").remove()};this.addOption=function(b,c){a("<option/>").val(b).remove().html(c).appendTo(this.id)};this.deleteOption=function(a){this.element.find("option[value=\""+a+"\"]").remove()};this.enable=function(){this.element.prop("disabled",!1)};this.disable=function(){this.element.prop("disabled",!0)}}function h(){this.id="#id_wikitags";this.element=a(this.id);this.showInEditMode=function(b){var c=this;b.each(function(){var b=a(this).attr("data-id");c.selectOption(b)});this.buildAutocompleteComponent()};this.selectOption=function(a){this.element.find("option[value=\""+a+"\"]").prop("selected",!0)};this.unselectOptions=function(){this.element.find("option:selected").prop("selected",!1)};this.buildAutocompleteComponent=function(){var a=this;d.get_strings([{key:"search",component:"wikifilter"},{key:"selectionarea",component:"wikifilter"}]).then(function(b){var d=b[0],e=b[1];a.element.nextAll().remove();c.enhance(a.id,!1,"",d,!1,!0,e,!0)}).fail(e.exception)};this.loadOptions=function(b){var c=this;this.element.empty();a.each(b,function(b,d){a("<option/>").val(b).html(d).appendTo(c.id)})};this.reset=function(){this.unselectOptions();this.buildAutocompleteComponent()}}function i(){this.associationsList=new f;this.associationRoleSelect=new g;this.associationTagsSelect=new h;this.associationEditorModal=a("#association-editor-modal");this.addTitle=a(".modal-title.add",this.associationEditorModal);this.editTitle=a(".modal-title.edit",this.associationEditorModal);this.addBtn=a(".add-btn",this.associationEditorModal);this.modifyBtn=a(".modify-btn",this.associationEditorModal);this.deleteBtn=a(".delete-icon");this.init=function(){this.events()};this.events=function(){this.showModalEvent();this.hideModalEvent();this.addEvent();this.modifyEvent();this.deleteEvent()};this.showModalEvent=function(){var b=this;this.associationEditorModal.on("show.bs.modal",function(c){var d=a(c.relatedTarget);if(d.hasClass("edit")){var e=d.closest(".actions").attr("data-roleid"),f=d.closest(".actions").attr("data-rolename");b.updateModalSections("edit");b.modifyBtn.attr("data-item",e);b.associationRoleSelect.showInEditMode({id:e,name:f});var g=d.closest("tr"),h=a(".tags span",g);b.associationTagsSelect.showInEditMode(h)}else{b.associationRoleSelect.showInAddMode(b.associationsList.table)}})};this.hideModalEvent=function(){var a=this;this.associationEditorModal.on("hidden.bs.modal",function(){a.updateModalSections("add");a.removeErrors();a.associationTagsSelect.reset()})};this.updateModalSections=function(a){if("edit"==a){this.addTitle.addClass("hidden");this.editTitle.removeClass("hidden");this.addBtn.addClass("hidden");this.modifyBtn.removeClass("hidden")}else{this.addTitle.removeClass("hidden");this.editTitle.addClass("hidden");this.addBtn.removeClass("hidden");this.modifyBtn.addClass("hidden")}};this.addEvent=function(){var b=this,c=this.associationsList,d=this.associationEditorModal;this.addBtn.click(function(){var e=a(".form-autocomplete-selection",d),f=b.validate(e);if(f){var g=b.associationRoleSelect.getSelectedOption(),h=a(".badge",e);c.addRow(g,h);a("tr:last .delete-icon",c.table).click(function(){var d=a(this).closest("tr"),e=a(".actions",d).attr("data-roleid"),f=a(".actions",d).attr("data-rolename");b.associationRoleSelect.addOption(e,f);c.deleteRow(d)});b.associationRoleSelect.deleteSelectedOption();d.modal("hide")}else{e.next().find("input").focus(function(){b.removeErrors()})}})};this.modifyEvent=function(){var b=this,c=this.associationsList,d=this.associationEditorModal;this.modifyBtn.click(function(){var e=a(".form-autocomplete-selection",d),f=b.validate(e);if(f){var g=b.associationRoleSelect.getSelectedOption(),h=a(".actions[data-roleid=\""+g.id+"\"]").closest("tr"),i=a(".badge",e);c.modifyRow(h,g,i);d.modal("hide")}else{e.next().find("input").focus(function(){b.removeErrors()})}})};this.deleteEvent=function(){var b=this,c=this.associationsList;this.deleteBtn.click(function(){var d=a(this).closest("tr"),e=a(".actions",d).attr("data-roleid"),f=a(".actions",d).attr("data-rolename");b.associationRoleSelect.addOption(e,f);c.deleteRow(d)})};this.validate=function(){this.removeErrors();var b=a(".form-autocomplete-selection",this.associationEditorModal);if(!a(".badge",b).length){a(".select-tag-error").removeClass("hidden");b.next().find("input").addClass("has-error");return!1}return!0};this.removeErrors=function(){a(".select-tag-error",this.associationEditorModal).addClass("hidden");a(".has-error",this.associationEditorModal).removeClass("has-error")}}function j(){this.wiki=a("#id_wiki");this.associations=a("#id_associations");this.associationsEditor=new i;this.init=function(){this.wikiChangeEvent();this.associationsEditor.init()};this.wikiChangeEvent=function(){var c=this;this.wiki.change(function(){var d=a(this).val();b.call([{methodname:"wikifilter_external_getwikipagestags",args:{id:d}}])[0].done(function(a){var b=JSON.parse(a);c.associationsEditor.associationsList.empty();c.associationsEditor.associationTagsSelect.loadOptions(b)}).fail(e.exception)})}}return{init:function init(){a(document).ready(function(){if(a("#id_wiki_header .alert-danger").length){a("#id_submitbutton").attr("disabled","disabled");a("#id_submitbutton2").attr("disabled","disabled")}else{var b=new j;b.init()}})}}});
//# sourceMappingURL=wikifilter.min.js.map
