define ("mod_wikifilter/wikifilter",["jquery","core/ajax","core/notification"],function(a,b,c){function d(){this.table=a("#id_associations_table");this.tableClone=a("#table_clone");this.rowClone=a(".row_clone",this.tableClone);this.emptyRowClone=a(".empty_row_clone",this.tableClone);this.addRow=function(b,c){var d=this.rowClone.clone();d.removeClass("row_clone");var e=this.buildRowData(b,c);this.fillRow(d,e);if(a("tr.empty_row").length){a("tr.empty_row").remove()}a("tbody",this.table).append(d)};this.modifyRow=function(a,b,c){var d=this.buildRowData(b,c);this.fillRow(a,d)};this.deleteRow=function(b){b.remove();if(!a("tbody .actions",this.table).length){var c=this.emptyRowClone.clone();c.removeClass("empty_row_clone").addClass("empty_row");a("tbody",this.table).append(c)}};this.empty=function(){if(!a(".empty_row",this.table).length){a("tbody .actions",this.table).closest("tr").remove();var b=this.emptyRowClone.clone();b.removeClass("empty_row_clone").addClass("empty_row");a("tbody",this.table).append(b)}};this.buildRowData=function(b,c){var d=b.name,e="",f="";c.each(function(){var c=a(this),d=c.attr("data-value"),g=c.text().replace("\xD7","");e+="<span class=\"badge badge-info mb-3 mr-1\" data-id=\""+b.id+"\">"+g+"</span>";f+="<input name=\"associations[]\" type=\"hidden\" value=\""+b.id+"-"+d+"\">"});var g={roleId:b.id,roleName:b.name,roleCell:d,tagsCell:e,actionsCell:f};return g};this.fillRow=function(b,c){a(".role",b).html(c.roleCell);a(".tags",b).html(c.tagsCell);a(".actions .db-data",b).html(c.actionsCell);a(".actions",b).attr("data-roleid",c.roleId);a(".actions",b).attr("data-rolename",c.roleName)}}function e(){this.associationsList=new d;this.associationEditorModal=a("#association-editor-modal");this.roleSelectId="#id_role";this.tagsSelectId="#id_wikitags";this.addBtn=a(".add-btn",this.associationEditorModal);this.modifyBtn=a(".modify-btn",this.associationEditorModal);this.deleteBtn=a(".delete-icon");this.init=function(){this.events()};this.events=function(){var b=this,c=a(this.roleSelectId);this.associationEditorModal.on("show.bs.modal",function(d){var e=a(d.relatedTarget);if(e.hasClass("edit")){var f=e.closest(".actions").attr("data-roleid"),g=e.closest(".actions").attr("data-rolename");b.addBtn.addClass("hidden");b.modifyBtn.removeClass("hidden").attr("data-item",f);a("<option/>").val(f).remove().html(g).appendTo(b.roleSelectId);c.val(f).attr("disabled","disabled")}else{c.removeAttr("disabled");a(".actions",b.associationsList.table).each(function(){var b=a(this).attr("data-roleid");c.find("option[value=\""+b+"\"]").remove()})}});this.associationEditorModal.on("hidden.bs.modal",function(){b.addBtn.removeClass("hidden");b.modifyBtn.addClass("hidden");b.removeErrors();b.resetTags()});this.addEvent();this.modifyEvent();this.deleteEvent()};this.addEvent=function(){var b=this,c=this.associationsList,d=this.associationEditorModal,e=a(this.roleSelectId,d);this.addBtn.click(function(){var f=a(".form-autocomplete-selection",d),g=b.validate(f);if(g){var h=e.val(),i=e.find("option:selected").text(),j=a(".badge",f);c.addRow({id:h,name:i},j);a("tr:last .delete-icon",c.table).click(function(){var d=a(this).closest("tr");b.updateRolesSelect(d);c.deleteRow(d)});e.find("option:selected").remove();d.modal("hide")}else{f.next().find("input").focus(function(){b.removeErrors()})}})};this.modifyEvent=function(){var b=this,c=this.associationsList,d=this.associationEditorModal,e=a(this.roleSelectId,d);this.modifyBtn.click(function(){var f=a(".form-autocomplete-selection",d),g=b.validate(f);if(g){var h=e.val(),i=e.find("option:selected").text(),j=a(".actions[data-roleid=\""+h+"\"]").closest("tr"),k=a(".badge",f);c.modifyRow(j,{id:h,name:i},k);d.modal("hide")}else{f.next().find("input").focus(function(){b.removeErrors()})}})};this.deleteEvent=function(){var b=this,c=this.associationsList;this.deleteBtn.click(function(){var d=a(this).closest("tr");b.updateRolesSelect(d);c.deleteRow(d)})};this.updateRolesSelect=function(b){var c=a(".actions",b).attr("data-roleid"),d=a(".actions",b).attr("data-rolename");a("<option/>").val(c).html(d).appendTo(this.roleSelectId)};this.updateTagsSelect=function(b){var c=this;this.associationsList.empty();a(c.tagsSelectId).empty();a.each(b,function(b,d){a("<option/>").val(b).html(d).appendTo(c.tagsSelectId)})};this.resetTags=function(){var b=a(".form-autocomplete-selection",this.associationEditorModal),c=a(".badge",b);c.each(function(){var b=a(this);b.trigger("click")})};this.validate=function(){this.removeErrors();var b=a(".form-autocomplete-selection",this.associationEditorModal);if(!a(".badge",b).length){a(".select-tag-error").removeClass("hidden");b.next().find("input").addClass("has-error");return!1}return!0};this.removeErrors=function(){a(".select-tag-error",this.associationEditorModal).addClass("hidden");a(".has-error",this.associationEditorModal).removeClass("has-error")}}function f(){this.wiki=a("#id_wiki");this.associations=a("#id_associations");this.associationsEditor=new e;this.init=function(){this.wikiChangeEvent();this.associationsEditor.init()};this.wikiChangeEvent=function(){var d=this;this.wiki.change(function(){var e=a(this).val();b.call([{methodname:"wikifilter_external_getwikipagestags",args:{id:e}}])[0].done(function(a){var b=JSON.parse(a);d.associationsEditor.updateTagsSelect(b)}).fail(c.exception)})}}return{init:function init(){a(document).ready(function(){if(a("#id_wiki_header .alert-danger").length){a("#id_submitbutton").attr("disabled","disabled");a("#id_submitbutton2").attr("disabled","disabled")}else{var b=new f;b.init()}})}}});
//# sourceMappingURL=wikifilter.min.js.map
