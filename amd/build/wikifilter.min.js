/**
 * JavaScript for the wikifilter form class.
 *
 * @module    mod_wikifilter/wikifilter
 * @author    Annouar Faraman <annouar.faraman@umontreal.ca>
 * @copyright 2021 Université de Montréal
 * @license   https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_wikifilter/wikifilter",["jquery","core/ajax","core/form-autocomplete","core/str","core/notification"],(function($,ajax,autocomplete,str,notification){function AssociationsList(){this.table=$("#id_associations_table"),this.tableClone=$("#table_clone"),this.rowClone=$(".row_clone",this.tableClone),this.emptyRowClone=$(".empty_row_clone",this.tableClone),this.addRow=function(selectedRole,selectedTags){var newRow=this.rowClone.clone();newRow.removeClass("row_clone");var newRowData=this.buildRowData(selectedRole,selectedTags);this.fillRow(newRow,newRowData),$("tr.empty_row").length&&$("tr.empty_row").remove(),$("tbody",this.table).append(newRow)},this.modifyRow=function(row,selectedRole,selectedTags){var rowData=this.buildRowData(selectedRole,selectedTags);this.fillRow(row,rowData)},this.deleteRow=function(row){if(row.remove(),!$("tbody .actions",this.table).length){var emptyRow=this.emptyRowClone.clone();emptyRow.removeClass("empty_row_clone").addClass("empty_row"),$("tbody",this.table).append(emptyRow)}},this.empty=function(){if(!$(".empty_row",this.table).length){$("tbody .actions",this.table).closest("tr").remove();var emptyRow=this.emptyRowClone.clone();emptyRow.removeClass("empty_row_clone").addClass("empty_row"),$("tbody",this.table).append(emptyRow)}},this.buildRowData=function(selectedRole,selectedTags){var roleCell=selectedRole.name,tagsCell="",actionsCell="";return selectedTags.each((function(){var thisTagElement=$(this),thisTagId=thisTagElement.attr("data-value"),thisTagText=thisTagElement.text().replace("×","");tagsCell+='<span class="badge badge-info mb-3 mr-1" data-id="'+thisTagId+'">'+thisTagText+"</span>",actionsCell+='<input name="associations[]" type="hidden" value="'+selectedRole.id+"-"+thisTagId+'">'})),{roleId:selectedRole.id,roleName:selectedRole.name,roleCell:roleCell,tagsCell:tagsCell,actionsCell:actionsCell}},this.fillRow=function(row,data){$(".role",row).html(data.roleCell),$(".tags",row).html(data.tagsCell),$(".actions .db-data",row).html(data.actionsCell),$(".actions",row).attr("data-roleid",data.roleId),$(".actions",row).attr("data-rolename",data.roleName)}}function AssociationRoleSelect(){this.id="#id_role",this.element=$(this.id),this.showInEditMode=function(role){this.addOption(role.id,role.name),this.setValue(role.id),this.disable()},this.showInAddMode=function(selectedRoles){var thisObject=this;this.enable(),$(".actions",selectedRoles).each((function(){var thisRoleId=$(this).attr("data-roleid");thisObject.deleteOption(thisRoleId)}))},this.setValue=function(value){this.element.val(value)},this.getSelectedOption=function(){return{id:this.element.val(),name:this.element.find("option:selected").text()}},this.deleteSelectedOption=function(){this.element.find("option:selected").remove()},this.addOption=function(key,value){$("<option/>").val(key).remove().html(value).appendTo(this.id)},this.deleteOption=function(id){this.element.find('option[value="'+id+'"]').remove()},this.enable=function(){this.element.prop("disabled",!1)},this.disable=function(){this.element.prop("disabled",!0)}}function AssociationTagsSelect(){this.id="#id_wikitags",this.element=$(this.id),this.showInEditMode=function(selectedTags){var thisObject=this;selectedTags.each((function(){var thisTagId=$(this).attr("data-id");thisObject.selectOption(thisTagId)})),this.buildAutocompleteComponent()},this.selectOption=function(id){this.element.find('option[value="'+id+'"]').prop("selected",!0)},this.unselectOptions=function(){this.element.find("option:selected").prop("selected",!1)},this.buildAutocompleteComponent=function(){var thisObject=this;str.get_strings([{key:"search",component:"wikifilter"},{key:"selectionarea",component:"wikifilter"}]).then((function(langstrings){var placeholder=langstrings[0],noSelectionString=langstrings[1];thisObject.element.nextAll().remove(),autocomplete.enhance(thisObject.id,!1,"",placeholder,!1,!0,noSelectionString,!0)})).fail(notification.exception)},this.loadOptions=function(data){var thisObject=this;this.element.empty(),$.each(data,(function(key,value){$("<option/>").val(key).html(value).appendTo(thisObject.id)}))},this.reset=function(){this.unselectOptions(),this.buildAutocompleteComponent()}}function AssociationsEditor(){this.associationsList=new AssociationsList,this.associationRoleSelect=new AssociationRoleSelect,this.associationTagsSelect=new AssociationTagsSelect,this.associationEditorModal=$("#association-editor-modal"),this.addTitle=$(".modal-title.add",this.associationEditorModal),this.editTitle=$(".modal-title.edit",this.associationEditorModal),this.addBtn=$(".add-btn",this.associationEditorModal),this.modifyBtn=$(".modify-btn",this.associationEditorModal),this.deleteBtn=$(".delete-icon"),this.init=function(){this.events()},this.events=function(){this.showModalEvent(),this.hideModalEvent(),this.addEvent(),this.modifyEvent(),this.deleteEvent()},this.showModalEvent=function(){var thisObject=this;this.associationEditorModal.on("show.bs.modal",(function(e){var callerBtn=$(e.relatedTarget);if(callerBtn.hasClass("edit")){var thisRoleId=callerBtn.closest(".actions").attr("data-roleid"),thisRoleName=callerBtn.closest(".actions").attr("data-rolename");thisObject.updateModalSections("edit"),thisObject.modifyBtn.attr("data-item",thisRoleId);var role={id:thisRoleId,name:thisRoleName};thisObject.associationRoleSelect.showInEditMode(role);var thisRoleRow=callerBtn.closest("tr"),thisRoleTags=$(".tags span",thisRoleRow);thisObject.associationTagsSelect.showInEditMode(thisRoleTags)}else thisObject.associationRoleSelect.showInAddMode(thisObject.associationsList.table)}))},this.hideModalEvent=function(){var thisObject=this;this.associationEditorModal.on("hidden.bs.modal",(function(){thisObject.updateModalSections("add"),thisObject.removeErrors(),thisObject.associationTagsSelect.reset()}))},this.updateModalSections=function(mode){"edit"==mode?(this.addTitle.addClass("hidden"),this.editTitle.removeClass("hidden"),this.addBtn.addClass("hidden"),this.modifyBtn.removeClass("hidden")):(this.addTitle.removeClass("hidden"),this.editTitle.addClass("hidden"),this.addBtn.removeClass("hidden"),this.modifyBtn.addClass("hidden"))},this.addEvent=function(){var thisObject=this,associationsList=this.associationsList,associationEditorModal=this.associationEditorModal;this.addBtn.click((function(){var tagsSelection=$(".form-autocomplete-selection",associationEditorModal);if(thisObject.validate(tagsSelection)){var selectedRole=thisObject.associationRoleSelect.getSelectedOption(),selectedTags=$(".badge",tagsSelection);associationsList.addRow(selectedRole,selectedTags),$("tr:last .delete-icon",associationsList.table).click((function(){var thisRow=$(this).closest("tr"),thisRoleId=$(".actions",thisRow).attr("data-roleid"),thisRoleName=$(".actions",thisRow).attr("data-rolename");thisObject.associationRoleSelect.addOption(thisRoleId,thisRoleName),associationsList.deleteRow(thisRow)})),thisObject.associationRoleSelect.deleteSelectedOption(),associationEditorModal.modal("hide")}else tagsSelection.next().find("input").focus((function(){thisObject.removeErrors()}))}))},this.modifyEvent=function(){var thisObject=this,associationsList=this.associationsList,associationEditorModal=this.associationEditorModal;this.modifyBtn.click((function(){var tagsSelection=$(".form-autocomplete-selection",associationEditorModal);if(thisObject.validate(tagsSelection)){var selectedRole=thisObject.associationRoleSelect.getSelectedOption(),thisRow=$('.actions[data-roleid="'+selectedRole.id+'"]').closest("tr"),selectedTags=$(".badge",tagsSelection);associationsList.modifyRow(thisRow,selectedRole,selectedTags),associationEditorModal.modal("hide")}else tagsSelection.next().find("input").focus((function(){thisObject.removeErrors()}))}))},this.deleteEvent=function(){var thisObject=this,associationsList=this.associationsList;this.deleteBtn.click((function(){var thisRow=$(this).closest("tr"),thisRoleId=$(".actions",thisRow).attr("data-roleid"),thisRoleName=$(".actions",thisRow).attr("data-rolename");thisObject.associationRoleSelect.addOption(thisRoleId,thisRoleName),associationsList.deleteRow(thisRow)}))},this.validate=function(){this.removeErrors();var selectionArea=$(".form-autocomplete-selection",this.associationEditorModal);return!!$(".badge",selectionArea).length||($(".select-tag-error").removeClass("hidden"),selectionArea.next().find("input").addClass("has-error"),!1)},this.removeErrors=function(){$(".select-tag-error",this.associationEditorModal).addClass("hidden"),$(".has-error",this.associationEditorModal).removeClass("has-error")}}function WikifilterEditor(){this.wiki=$("#id_wiki"),this.associations=$("#id_associations"),this.associationsEditor=new AssociationsEditor,this.init=function(){this.wikiChangeEvent(),this.associationsEditor.init()},this.wikiChangeEvent=function(){var thisObject=this;this.wiki.change((function(){var wikiID=$(this).val(),course=$("input[name=course]").val();ajax.call([{methodname:"wikifilter_external_getwikipagestags",args:{id:wikiID,course:course}}])[0].done((function(response){var data=JSON.parse(response);thisObject.associationsEditor.associationsList.empty(),thisObject.associationsEditor.associationTagsSelect.loadOptions(data)})).fail(notification.exception)}))}}return{init:function(){$(document).ready((function(){$("#id_wiki_header .alert-danger").length?($("#id_submitbutton").attr("disabled","disabled"),$("#id_submitbutton2").attr("disabled","disabled")):(new WikifilterEditor).init()}))}}}));

//# sourceMappingURL=wikifilter.min.js.map